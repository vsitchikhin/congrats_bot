# Дорожная карта разработки Telegram-бота для новогодних поздравлений

## Этап 1: Настройка и подготовка проекта

1.  **Анализ существующей кодовой базы:**
    *   Изучить структуру проекта, основные зависимости (`grammy`, `hono`, `pino`, `valibot`) и конфигурационные файлы. (Уже выполнено).

2.  **Проектирование моделей данных:**
    *   Определить структуру данных для хранения информации о пользователе и его заказе (`userId`, `chatId`, `phoneNumber`, `childName`, `status`, `generatedVideoPath`).
    *   Для этого можно будет использовать Prisma ORM, которая уже упоминается в примерах к шаблону.

3.  **Выбор системы очередей:**
    *   Использовать связку **Redis + BullMQ** для надежной и масштабируемой обработки задач.
    *   Это позволит эффективно управлять очередью генерации видео, а также использовать такие возможности, как повторные попытки, отложенные задачи и мониторинг через UI.

## Этап 2: Реализация взаимодействия с пользователем (Bot Flow)

1.  **Реализация команды `/start`:**
    *   Создать новый "feature" (`/src/bot/features/new-year-greeting.ts`), который будет обрабатывать команду `/start` и запускать диалог с пользователем.

2.  **Создание диалога с пользователем:**
    *   Использовать плагин `grammy/conversations` (упомянут в `README.md`) для создания пошагового диалога:
        *   Запрос номера телефона с валидацией.
        *   Запрос имени ребенка.
        *   Подтверждение введенных данных.

3.  **Сохранение данных и постановка в очередь:**
    *   После успешного прохождения диалога, сохранить данные пользователя в базу данных.
    *   Добавить новую задачу в очередь на генерацию видео.
    *   Отправить пользователю сообщение о том, что его поздравление принято в работу.

## Этап 3: Реализация логики очереди

1.  **Создание сервиса очереди:**
    *   Реализовать класс или модуль, который будет управлять очередью (добавление, получение задачи).

2.  **Реализация воркера (фонового обработчика):**
    *   Создать воркер, который будет в цикле или по триггеру забирать задачи из очереди.
    *   Воркер должен вызывать сервисы для генерации видео и обновлять статус задачи в базе данных.

## Этап 4: Реализация логики генерации видео

1.  **Генерация аудио-обращения:**
    *   Выбрать сервис для синтеза речи (Text-to-Speech), который поддерживает русский язык.
    *   Реализовать сервис, который будет принимать имя ребенка, определять его пол для правильного обращения ("Дорогой" или "Дорогая") и генерировать аудиофайл с обращением.
    *   Сохранять сгенерированный аудиофайл во временное хранилище.

2.  **Обработка видео:**
    *   Выбрать инструмент для обработки видео, например, `ffmpeg`.
    *   Реализовать сервис, который будет:
        *   Принимать на вход основное видео и сгенерированный аудиофайл с обращением.
        *   Накладывать сгенерированное аудио на начало основного видео (заменять существующую аудиодорожку или добавлять новую).
        *   Сохранять финальное видео в постоянное хранилище.

## Этап 5: Интеграция и отправка готового видео

1.  **Интеграция воркера и генераторов:**
    *   Воркер из Этапа 3 должен вызывать сервисы из Этапа 4 для каждой задачи в очереди.

2.  **Обновление статуса и отправка:**
    *   После успешной генерации видео, воркер должен обновить запись в базе данных, указав путь к готовому файлу.
    *   После обновления статуса, бот должен отправить сгенерированное видео пользователю. Для этого можно использовать `bot.api.sendVideo`.

## Этап 6: Тестирование и отладка

1.  **Модульное тестирование:**
    *   Написать тесты для отдельных модулей: валидация данных, работа с очередью, сервисы генерации.

2.  **Интеграционное тестирование:**
    *   Проверить весь флоу от начала диалога с ботом до получения готового видео.
    *   Отладить возможные проблемы, связанные с интеграцией различных сервисов.

## Этап 7: Деплой

1.  **Докеризация приложения и локальное окружение:**
    *   Разработать Dockerfile для приложения (бота и воркера) и настроить `docker-compose.yml` для локальной разработки и тестирования, включая Redis, базу данных и, при необходимости, `bull-board` для мониторинга очередей. Это обеспечит переносимость и простоту развертывания.
2.  **Подготовка к развертыванию на production:**
    *   Настроить переменные окружения для production-среды.
    *   Изучить и применить инструкции по деплою (например, на Vercel или другом хостинге с поддержкой Docker), которые уже есть или будут дополнены в документации проекта (`README.md`).
