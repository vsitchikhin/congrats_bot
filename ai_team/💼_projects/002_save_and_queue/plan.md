# План реализации Задачи 2.3: Сохранение данных и постановка задачи в очередь

## Описание задачи
После того как пользователь подтвердил все введенные данные (имя ребенка), они должны быть сохранены в базу данных через Prisma, а затем создана новая задача в очереди BullMQ для дальнейшей обработки.

## Текущее состояние
- ✅ Модель `VideoJob` уже существует в `prisma/schema.prisma` со всеми необходимыми полями
- ✅ Очередь `greetingQueue` уже создана в `src/queue/definitions/greeting.ts`
- ✅ Процессор `greetingProcessor` существует в `src/queue/processors/greeting.ts`
- ✅ В `src/bot/features/greeting.ts` на строке 192 есть TODO для реализации этой задачи
- ✅ Данные пользователя (User) уже сохраняются в БД после получения номера телефона

## План действий

### 1. Импорт зависимостей
В файле `src/bot/features/greeting.ts` добавить импорт:
```typescript
import { greetingQueue } from '#root/queue/definitions/greeting.js';
```

### 2. Создание VideoJob в базе данных
После подтверждения имени ребенка (вместо TODO на строке 192):
- Создать запись `VideoJob` в БД с помощью `prisma.videoJob.create()`
- Использовать данные:
  - `userId`: `ctx.from!.id` (преобразовать в BigInt)
  - `childName`: собранное имя ребенка
  - `phoneNumber`: собранный номер телефона из шага 1
  - `status`: по умолчанию будет `PENDING` (установлено в схеме)
- Получить `id` созданной записи для передачи в очередь

### 3. Добавление задачи в BullMQ очередь
- Вызвать `greetingQueue.add()` с данными типа `GreetingJobData`:
  ```typescript
  await greetingQueue.add('generate-video', { jobId: videoJob.id });
  ```
- Передать `jobId` созданного VideoJob

### 4. Обработка ошибок
Обернуть операции в `try-catch` блок для обработки возможных ошибок:
- **Ошибка сохранения в БД**: сообщить пользователю о проблеме, попросить попробовать позже
- **Ошибка постановки в очередь**: если VideoJob создан, но постановка в очередь не удалась:
  - Либо обновить статус VideoJob на FAILED
  - Либо попытаться повторить операцию
  - Сообщить пользователю о проблеме

### 5. Обеспечение атомарности
Для решения проблемы race condition (задача создана в БД, но не добавлена в очередь):
- **Вариант 1 (простой)**: Если постановка в очередь не удалась, пометить VideoJob как FAILED
- **Вариант 2 (продвинутый)**: Использовать транзакцию Prisma, но учесть, что BullMQ не поддерживает транзакции напрямую
- **Рекомендация**: Использовать вариант 1 для начала, так как BullMQ и так обеспечивает надежность

### 6. Информирование пользователя
- Сообщение об успешной постановке в очередь уже есть: "⏳ Отлично! Ваш заказ принят в обработку..."
- При ошибке: сообщить пользователю конкретную проблему

## Пример кода

```typescript
// Step 4: Create video job and add to queue
try {
  // Create VideoJob in database
  const videoJob = await prisma.videoJob.create({
    data: {
      userId: BigInt(ctx.from!.id),
      childName,
      phoneNumber,
      status: 'PENDING',
    },
  });

  // Add job to BullMQ queue
  await greetingQueue.add('generate-video', {
    jobId: videoJob.id,
  });

  await ctx.reply('⏳ Отлично! Ваш заказ принят в обработку...');
} catch (error) {
  console.error('Failed to create video job:', error);
  await ctx.reply('Произошла ошибка при создании заказа. Пожалуйста, попробуйте позже, используя команду /start');
}
```

## Зависимости
- `@prisma/client` (уже установлен)
- `bullmq` (уже установлен)
- `#root/queue/definitions/greeting.js` (уже существует)
- `#root/db/client.js` (уже используется)

## Потенциальные риски
- **Race condition**: VideoJob создан, но не добавлен в очередь
  - **Решение**: Обработка ошибок с установкой статуса FAILED
- **Сбой Redis**: Очередь недоступна
  - **Решение**: Catch ошибки и сообщение пользователю
- **Дублирование заказов**: Пользователь может создать несколько заказов
  - **Решение**: Пока не критично, можно добавить проверку позже
- **Большое количество pending заказов**: Если Worker не работает
  - **Решение**: Мониторинг и алерты (вне скоупа текущей задачи)

## Файлы для изменения
- `src/bot/features/greeting.ts` (строка 192, заменить TODO на реализацию)

## Критерии приемки
- ✅ После подтверждения имени создается запись VideoJob в БД
- ✅ Задача добавляется в BullMQ очередь с правильным jobId
- ✅ Пользователь получает сообщение об успешной постановке в обработку
- ✅ Ошибки корректно обрабатываются и сообщаются пользователю
- ✅ Нет необработанных исключений
