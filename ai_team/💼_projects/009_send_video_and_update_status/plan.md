# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ó–∞–¥–∞—á–∏ 5.1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ

## –°—Ç–∞—Ç—É—Å
‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

## –û–ø–∏—Å–∞–Ω–∏–µ
–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ —Ñ–∞–π–ª–µ `src/queue/processors/video-generation.ts`. –õ–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∑–∞–¥–∞—á–∏.

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–ö–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

1.  **–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
    *   –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç `jobId` –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏.
    *   –í—Å—è –ª–æ–≥–∏–∫–∞ –æ–±–µ—Ä–Ω—É—Ç–∞ –≤ `try-catch` –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
    *   **–°—Ç–∞—Ç—É—Å `VideoJob` –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `PROCESSING`** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

2.  **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
    *   –ò–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ `VideoJob`, –≤–∫–ª—é—á–∞—è –¥–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`user`).

3.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–¥–∏–∞:**
    *   –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `ttsService.generate()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞.
    *   –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `videoService.mergeAudioWithVideo()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ.

4.  **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `botApi.sendVideo()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `InputFile`.
    *   –í –∫–∞—á–µ—Å—Ç–≤–µ `chat_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `videoJob.userId`.
    *   –ö –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å: "–í–æ—Ç –≤–∞—à–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ! üéâ".

5.  **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:**
    *   **–°—Ç–∞—Ç—É—Å `VideoJob` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `COMPLETED`**.
    *   –õ–æ–≥–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.
    *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º "–í–∞—à–µ –≤–∏–¥–µ–æ–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è {–∏–º—è} –≥–æ—Ç–æ–≤–æ! üéä" –∏ `InlineKeyboard` —Å –∫–Ω–æ–ø–∫–æ–π "–ó–∞–∫–∞–∑–∞—Ç—å –µ—â–µ –æ–¥–Ω–æ –≤–∏–¥–µ–æ" (`order_another_video`).

6.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
    *   –í –±–ª–æ–∫–µ `catch` –ª—é–±–∞—è –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è.
    *   **–°—Ç–∞—Ç—É—Å `VideoJob` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `FAILED`** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    *   –û—à–∏–±–∫–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ (`throw error`), —á—Ç–æ–±—ã BullMQ –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –µ–µ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–≤–æ–µ–π –ª–æ–≥–∏–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫).

## –§–∞–π–ª—ã
-   `src/queue/processors/video-generation.ts`: –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª, –≥–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤—Å—è –ª–æ–≥–∏–∫–∞.
-   `prisma/schema.prisma`: –ú–æ–¥–µ–ª—å `VideoJob` —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ `PENDING`, `PROCESSING`, `COMPLETED`, `FAILED`.

## –í—ã–≤–æ–¥
–ó–∞–¥–∞—á–∞ 5.1 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
