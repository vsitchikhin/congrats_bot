# üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ó–∞–¥–∞—á–∏ 5.2: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∏–º–µ–Ω. –≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–Ω–∏–∑–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É.

---

## 1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (`prisma/schema.prisma`)

**–¶–µ–ª—å:** –û—Ç–¥–µ–ª–∏—Ç—å *–∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è* –æ—Ç *–∑–∞–¥–∞—á–∏ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é*.

- **–®–∞–≥ 1.1:** –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `VideoJob` –≤ `UserRequest`. –≠—Ç–∞ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–®–∞–≥ 1.2:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å `VideoAsset`. –û–Ω–∞ –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–µ–¥–∏–∞-—Ä–µ—Å—É—Ä—Å (–≤–∏–¥–µ–æ), —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–º–µ–Ω–µ–º.

```prisma
// prisma/schema.prisma

// ... (User model remains the same) ...

// –°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–º–æ–≥–æ –∞—Å—Å–µ—Ç–∞
enum AssetStatus {
  PENDING     // –û–∂–∏–¥–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  GENERATING  // –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  AVAILABLE   // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  FAILED      // –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
}

// –ù–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å: —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –∏–º–µ–Ω–∏
model VideoAsset {
  id              String      @id @default(cuid())
  name            String      @unique // –ò–º—è —Ä–µ–±–µ–Ω–∫–∞, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º
  status          AssetStatus @default(PENDING)
  telegramFileId  String?     // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π file_id –∏–∑ Telegram
  
  // –°–≤—è–∑—å —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  userRequests UserRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
enum RequestStatus {
  PENDING     // –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  COMPLETED   // –í–∏–¥–µ–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
  FAILED      // –û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
}

// –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å VideoJob
model UserRequest {
  id        String        @id @default(cuid())
  status    RequestStatus @default(PENDING)

  user      User          @relation(fields: [userId], references: [id])
  userId    BigInt

  // –°–≤—è–∑—å —Å –≤–∏–¥–µ–æ-–∞—Å—Å–µ—Ç–æ–º
  asset     VideoAsset    @relation(fields: [assetId], references: [id])
  assetId   String

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([userId, status])
}
```

- **–®–∞–≥ 1.3:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `npx prisma migrate dev --name video_caching_refactor`
- **–®–∞–≥ 1.4:** –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç Prisma: `npx prisma generate`

---

## 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—Ö–æ–¥–∞ (Producer - `src/bot/features/greeting.ts`)

**–¶–µ–ª—å:** –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ—à–∞—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.

- **–®–∞–≥ 2.1:** –í–Ω–µ–¥—Ä–∏—Ç—å `prisma.$transaction` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π.
- **–®–∞–≥ 2.2:** –í–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
    1.  –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å `VideoAsset` –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `findUnique` –ø–æ –ø–æ–ª—é `name`.
    2.  **–ï—Å–ª–∏ `VideoAsset` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
        -   –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å `UserRequest`, —Å–≤—è–∑—ã–≤–∞—é—â—É—é `userId` —Å `assetId`.
        -   –ï—Å–ª–∏ `asset.status === 'AVAILABLE'`, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ, –∏—Å–ø–æ–ª—å–∑—É—è `asset.telegramFileId`, –∏ –ø–æ–º–µ—Ç–∏—Ç—å `UserRequest` –∫–∞–∫ `COMPLETED`.
        -   –ï—Å–ª–∏ `asset.status` –∏–Ω–æ–π (`PENDING` –∏–ª–∏ `GENERATING`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ "–ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è" –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è.
    3.  **–ï—Å–ª–∏ `VideoAsset` –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
        -   –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `VideoAsset` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`.
        -   –°–æ–∑–¥–∞—Ç—å `UserRequest`, —Å–≤—è–∑—ã–≤–∞—é—â–∏–π `userId` —Å `assetId` –Ω–æ–≤–æ–≥–æ –∞—Å—Å–µ—Ç–∞.
        -   **–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å BullMQ –∑–∞–¥–∞—á—É `generate-video` —Å –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π `{ assetId: newAsset.id }`**.

---

## 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (Consumer - `src/queue/processors/video-generation.ts`)

**–¶–µ–ª—å:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –¥–ª—è `VideoAsset` –∏ —Ä–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º "–ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º".

- **–®–∞–≥ 3.1:** –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `{ assetId }` –∏–∑ –∑–∞–¥–∞—á–∏.
- **–®–∞–≥ 3.2:** –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
    1.  –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å `VideoAsset` –Ω–∞ `GENERATING`.
    2.  –í—ã–ø–æ–ª–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞—É–¥–∏–æ (`ttsService`) –∏ –≤–∏–¥–µ–æ (`videoService`).
    3.  –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö `UserRequest`, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —ç—Ç–∏–º `assetId` (`include: { user: true }`).
    4.  –í–∑—è—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–º—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∫–∞–∫ `InputFile`. **–ò–∑ –æ—Ç–≤–µ—Ç–∞ Telegram –∏–∑–≤–ª–µ—á—å `file_id`**.
    5.  –û–±–Ω–æ–≤–∏—Ç—å `VideoAsset`: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `status = 'AVAILABLE'` –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `telegramFileId`.
    6.  **–ü—Ä–æ–π—Ç–∏—Å—å –ø–æ –æ—Å—Ç–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–º –≤–∏–¥–µ–æ, –∏—Å–ø–æ–ª—å–∑—É—è —É–∂–µ **–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `telegramFileId`**. –≠—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ Telegram.
    7.  –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö `UserRequest` –Ω–∞ `COMPLETED`.
- **–®–∞–≥ 3.3:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
    -   –í —Å–ª—É—á–∞–µ —Å–±–æ—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å `VideoAsset` –Ω–∞ `FAILED`.
    -   –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö `UserRequest` –Ω–∞ `FAILED`.

---

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

-   **–ì–æ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `VideoAsset`:** –ü—Ä–æ–±–ª–µ–º–∞, –∫–æ–≥–¥–∞ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—ã—Ç–∞—é—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∞—Å—Å–µ—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–º–µ–Ω–∏.
    -   **–†–µ—à–µ–Ω–∏–µ:** –û–±–µ—Ä–Ω—É—Ç—å –ª–æ–≥–∏–∫—É "–Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å" –≤ `greeting.ts` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å —É—Ä–æ–≤–Ω–µ–º –∏–∑–æ–ª—è—Ü–∏–∏ `Serializable` (`prisma.$transaction(..., { isolationLevel: 'Serializable' })`), —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å.
