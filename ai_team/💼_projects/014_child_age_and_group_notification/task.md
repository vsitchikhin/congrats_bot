# Task 014: –°–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ä–µ–±–µ–Ω–∫–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É

**Status:** üü° SIMPLE
**Created:** 2025-12-28
**Estimated Time:** ~2h

---

## üìù Description

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–µ –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –≤ –±–æ—Ç–∞:
1. –ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –∏–º–µ–Ω–∏ —Ä–µ–±–µ–Ω–∫–∞, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞
2. –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é Telegram –≥—Ä—É–ø–ø—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—è–≤–∫–µ

---

## üéØ Requirements

### 1. –°–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ä–µ–±–µ–Ω–∫–∞

- –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∏–º—è —Ä–µ–±–µ–Ω–∫–∞, –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞:
  - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
  - –î–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç 1 –¥–æ 18 –ª–µ—Ç
  - –ü—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –≤–≤–æ–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –≤–º–µ—Å—Ç–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º UserRequest (—Ç–∞–∫ –∫–∞–∫ —Ä–∞–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –¥–ª—è –¥–µ—Ç–µ–π —Ä–∞–∑–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞)

### 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É

- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É: `https://t.me/+CIzSyLXgy7Q1OGJi`
- –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:
  ```
  –ó–∞—è–≤–∫–∞ –æ—Ç @username
  üßí –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞: 7
  ‚òéÔ∏è –¢–µ–ª–µ—Ñ–æ–Ω: 79191841319
  ```
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç username, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è: `–ó–∞—è–≤–∫–∞ –æ—Ç –ò–≤–∞–Ω`
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ `type === 'generate'`)
- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ (`type === 'send_cached'`) –∏–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫ (`type === 'subscribed'`)

---

## üîß Technical Details

**Files to modify:**

1. `prisma/schema.prisma`
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `childAge Int?` –≤ –º–æ–¥–µ–ª—å `UserRequest`
   - –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

2. `src/bot/features/greeting.ts`
   - –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–µ–Ω–∏
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤–æ–∑—Ä–∞—Å—Ç–∞
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ UserRequest
   - –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É
   - –í—ã–∑—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å (–∫–æ–≥–¥–∞ `result.type === 'generate'`)

3. `src/config.ts`
   - –î–æ–±–∞–≤–∏—Ç—å `NOTIFICATION_GROUP_CHAT_ID` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–º–æ–∂–Ω–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å –∏–ª–∏ –≤–∑—è—Ç—å –∏–∑ env)

**Implementation Steps:**

```typescript
// –í conversation –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–µ–Ω–∏ (–ø–æ—Å–ª–µ line 369)

// Step 4.5: Ask for child's age
let childAge: number | undefined;
let ageConfirmed = false;

while (!ageConfirmed) {
  await ctx.reply('–°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Ä–µ–±–µ–Ω–∫—É? üéÇ\n\n–í–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç (–æ—Ç 1 –¥–æ 18 –ª–µ—Ç):');

  const ageCtx = await conversation.waitFor('message:text');

  // Check for cancellation
  if (ageCtx.message?.text === '/cancel') {
    // Handle cancel
  }

  const ageInput = ageCtx.message?.text?.trim();
  const age = parseInt(ageInput || '', 10);

  // Validate age
  if (isNaN(age) || age < 1 || age > 18) {
    await ctx.reply('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –æ—Ç 1 –¥–æ 18 –ª–µ—Ç.');
    continue;
  }

  childAge = age;
  ageConfirmed = true;
}

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ UserRequest –ø–µ—Ä–µ–¥–∞—Ç—å childAge
// –ü—Ä–∏ result.type === 'generate' –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
```

**Notification function:**

```typescript
async function sendGroupNotification(
  bot: Api,
  chatId: string | number,
  username: string | undefined,
  firstName: string,
  phoneNumber: string,
  childAge: number | undefined,
) {
  const userDisplay = username ? `@${username}` : firstName;
  const ageText = childAge ? `üßí –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞: ${childAge}` : 'üßí –í–æ–∑—Ä–∞—Å—Ç: –Ω–µ —É–∫–∞–∑–∞–Ω';

  const message = `–ó–∞—è–≤–∫–∞ –æ—Ç ${userDisplay}\n${ageText}\n‚òéÔ∏è –¢–µ–ª–µ—Ñ–æ–Ω: ${phoneNumber}`;

  await bot.sendMessage(chatId, message);
}
```

---

## ‚úÖ Acceptance Criteria

- [ ] –ü–æ–ª–µ `childAge` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–æ–¥–µ–ª—å `UserRequest`
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–µ–Ω–∏ –±–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (1-18 –ª–µ—Ç, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞)
- [ ] –í–æ–∑—Ä–∞—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `UserRequest`
- [ ] –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
- [ ] –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ –∏–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å–ª—É—á–∞–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è username —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üì¢ Next Steps

üì¢ @alex - need architecture plan for age collection and group notification!
