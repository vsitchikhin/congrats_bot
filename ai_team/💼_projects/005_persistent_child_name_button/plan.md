# -*- mode: markdown; fill-column: 80 -*-

# üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ (–ó–∞–¥–∞—á–∏ #005 –∏ #006)

–≠—Ç–æ—Ç –ø–ª–∞–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–≤–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ –≥–ª–∞–¥–∫–æ–≥–æ –∏ —É–º–Ω–æ–≥–æ
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1.  **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î (`prisma/schema.prisma`):**
    *   –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å `Child` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω –¥–µ—Ç–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        ```prisma
        model Child {
          id        Int      @id @default(autoincrement())
          name      String
          createdAt DateTime @default(now())
          updatedAt DateTime @updatedAt

          user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
          userId BigInt
        }
        ```
    *   –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –≤ –º–æ–¥–µ–ª—å `User`: `children Child[]`.
    *   –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `npx prisma migrate dev --name add_child_model`.
    *   –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç: `npx prisma generate`.

2.  **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (`src/bot/keyboards/persistent.ts`):**
    *   –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è "–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π" –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `InlineKeyboard`.
    *   –ï—Å–ª–∏ –¥–µ—Ç–µ–π 0, —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏: "–£–∫–∞–∑–∞—Ç—å –∏–º—è —Ä–µ–±–µ–Ω–∫–∞".
    *   –ï—Å–ª–∏ –¥–µ—Ç–µ–π > 0, —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏: "–£–∫–∞–∑–∞—Ç—å –µ—â–µ –æ–¥–Ω–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞".
    *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `callback_data` –¥–ª—è –∫–Ω–æ–ø–æ–∫, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ
        –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `p:child:add`).

3.  **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (`src/bot/features/greeting.ts`):**
    *   **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ `replyWithPersistentKeyboard`:** –°–æ–∑–¥–∞—Ç—å
        –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö –ø–æ—Ç–æ–∫–∞.
        –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–µ—Ç—å–º–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å
        –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.
    *   **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã `/start`:**
        *   –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î, –≤–∫–ª—é—á–∞—è `children` (`include: { children:
          true }`).
        *   **–ï—Å–ª–∏ `user.phoneNumber` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
            *   –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞.
            *   –í—ã–∑–≤–∞—Ç—å `replyWithPersistentKeyboard`.
        *   **–ï—Å–ª–∏ `user.phoneNumber` –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
            *   –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ç–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—á–µ—Ä–µ–∑ –±–µ—Å–µ–¥—É
                `contactConversation`).
    *   **–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –≤ `contactConversation`:**
        *   –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤—ã–∑–≤–∞—Ç—å
          `replyWithPersistentKeyboard`, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–∏—Ç—å
          —Ä–µ–±–µ–Ω–∫–∞.
    *   **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∫–Ω–æ–ø–∫–∏ `p:child:add`:**
        *   –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É (`childNameConversation`) –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
          —Ä–µ–±–µ–Ω–∫–∞.

4.  **–ë–µ—Å–µ–¥–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ —Ä–µ–±–µ–Ω–∫–∞ (`childNameConversation`):**
    *   –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É –≤ `src/bot/features/greeting.ts`.
    *   –û–Ω–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ë–î, —Å–≤—è–∑—ã–≤–∞—è —Å `ctx.state.user.id`.
    *   –í —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∏–º–µ–Ω–∏ —Ä–µ–±–µ–Ω–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±—É–∫–≤—ã "—ë" (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ctx.reply(ctx.t('child-name.prompt-with-yo-instruction'))`).
    *   –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `replyWithPersistentKeyboard`, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å
        —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏.

5.  **–ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (`locales/ru.ftl`):**
    *   –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤ –∫–Ω–æ–ø–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
    *   –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á `child-name.prompt-with-yo-instruction = –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–±–µ–Ω–∫–∞. –ï—Å–ª–∏ –≤ –∏–º–µ–Ω–∏ –µ—Å—Ç—å –±—É–∫–≤–∞ '—ë' (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–ª—ë–Ω–∞), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–µ–Ω–Ω–æ '—ë' –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–≤—É–∫–∞.`

6.  **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (`tests/features/greeting.test.ts`):**
    *   –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
        *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
        *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–æ–º–µ—Ä–æ–º, –Ω–æ –±–µ–∑ –¥–µ—Ç–µ–π.
        *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–æ–º–µ—Ä–æ–º –∏ –æ–¥–Ω–∏–º/–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–µ—Ç—å–º–∏.
        *   –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –¥–µ—Ç–µ–π.

7.  **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º (Race Conditions):**
    *   **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ —Ä–µ–±–µ–Ω–∫–∞. –í
        —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤–æ—Ä–∫–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–¥–∞—á—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤–æ–µ
        –≤–∏–¥–µ–æ. –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–±–∏–≤–∞—Ç—å –±–æ—Ç–∞ —Å —Ç–æ–ª–∫—É.
    *   **–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞–≥–∏–Ω `@grammyjs/conversations` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∏–º—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è
        –≤–∏–¥–µ–æ, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏
        (`await conversation.wait()`) –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–≤–æ–¥.
    *   **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç, —Å–∏–º—É–ª–∏—Ä—É—é—â–∏–π —ç—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π:
        1.  –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ—Å–µ–¥—É –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏.
        2.  *–ü–µ—Ä–µ–¥* —Ç–µ–º, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–æ—Ç–≤–µ—Ç–∏—Ç", —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
            —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∏–º–µ–Ω–∏ –≤–æ—Ä–∫–µ—Ä–∞.
        3.  –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ –µ—â–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
            –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –±–µ—Å–µ–¥–æ–π.
