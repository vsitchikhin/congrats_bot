# üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ó–∞–¥–∞—á–∏ 4.2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –º–æ–Ω—Ç–∞–∂ –≤–∏–¥–µ–æ (`ffmpeg`)

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å `src/services/video.ts` –¥–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ (—Å –∏–º–µ–Ω–µ–º —Ä–µ–±–µ–Ω–∫–∞) –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `ffmpeg`.

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1.  **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`src/config.ts` –∏ `.env.example`):**
    *   –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `SOURCE_VIDEO_PATH` (—Å—Ç—Ä–æ–∫–∞, –ø—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É-—à–∞–±–ª–æ–Ω—É) –∏ `AUDIO_INSERT_TIMECODE` (—Å—Ç—Ä–æ–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, "00:00:05", —Ç–∞–π–º–∫–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∞—É–¥–∏–æ) –≤ `src/config.ts` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ `Valibot`.
    *   –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏-–∑–∞–≥–ª—É—à–∫–∏ –≤ `.env.example`.

2.  **–í–∏–¥–µ–æ—Å–µ—Ä–≤–∏—Å (`src/services/video.ts`):**
    *   –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª `src/services/video.ts`.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `mergeAudioWithVideo(audioPath: string): Promise<string>`, –∫–æ—Ç–æ—Ä–∞—è:
        *   –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—É—Ç—å –∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∞—É–¥–∏–æ—Ñ–∞–π–ª—É.
        *   –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É `ffmpeg` –¥–ª—è:
            *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `SOURCE_VIDEO_PATH` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞.
            *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `audioPath` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥–Ω–æ–≥–æ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞.
            *   –ù–∞–ª–æ–∂–µ–Ω–∏—è –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞ –∏–∑ `audioPath` –Ω–∞ –≤–∏–¥–µ–æ, –Ω–∞—á–∏–Ω–∞—è —Å `AUDIO_INSERT_TIMECODE`. –ò—Å—Ö–æ–¥–Ω—ã–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –≤–∏–¥–µ–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω —Å –Ω–æ–≤—ã–º –∏–ª–∏ –∑–∞–º–µ–Ω–µ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (–¥–ª—è –Ω–∞—á–∞–ª–∞, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫).
            *   –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ (`SOURCE_VIDEO_PATH`) –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º.
            *   –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `./temp/videos/`) —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `final-video-timestamp.mp4`).
        *   –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `ffmpeg` —Å –ø–æ–º–æ—â—å—é `child_process.spawn` (–∏–ª–∏ `exec`, –Ω–æ `spawn` –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –¥–ª—è –¥–æ–ª–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤).
        *   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–≤–æ–¥ `ffmpeg` (stdout, stderr) –∏ –∫–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏.
        *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `ffmpeg`, –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

3.  **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–æ—Ä–∫–µ—Ä–æ–º (`src/queue/processors/video-generation.ts`):**
    *   –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `videoService` –≤ `src/queue/processors/video-generation.ts`.
    *   –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `ttsService.generate`, –≤—ã–∑–≤–∞—Ç—å `const videoPath = await videoService.mergeAudioWithVideo(audioPath);`.
    *   `videoPath` –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ó–∞–¥–∞—á–∞ 5.1).

4.  **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker (`Dockerfile`, `docker-compose.yml`):**
    *   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `ffmpeg` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Docker-–æ–±—Ä–∞–∑–µ –≤–æ—Ä–∫–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `RUN apt-get update && apt-get install -y ffmpeg`).
    *   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `SOURCE_VIDEO_PATH` –∏ `AUDIO_INSERT_TIMECODE` –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Å–µ—Ä–≤–∏—Å `worker`.
    *   –û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏—Å—Ö–æ–¥–Ω—ã–º –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `./assets`) –≤–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–º–æ–≤ –≤ `docker-compose.yml`).

5.  **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
    *   –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å–Ω—ã–µ/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è `videoService.mergeAudioWithVideo` –≤ `tests/services/video.test.ts`. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `child_process` mocking –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å `ffmpeg`.
    *   –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ, –æ—à–∏–±–∫–∏ `ffmpeg`, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—É—Ç–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–∏–¥–µ–æ.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `child_process` (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å Node.js).
- `node:fs/promises` –∏ `node:path` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π.
- `ffmpeg` (—Å–∏—Å—Ç–µ–º–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞).

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏
- –ü—Ä–æ–±–ª–µ–º—ã —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `ffmpeg` –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏–ª–∏ –≤ —Å—Ä–µ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤ –æ—Ç–ª–∞–¥–∫–µ –∫–æ–º–∞–Ω–¥ `ffmpeg`.
- –í—ã—Å–æ–∫–∞—è —Ä–µ—Å—É—Ä—Å–æ–µ–º–∫–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π —Å –≤–∏–¥–µ–æ, —á—Ç–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ—Ä–∫–µ—Ä–∞.
- –û—à–∏–±–∫–∏ –≤ –ø—É—Ç—è—Ö –∫ —Ñ–∞–π–ª–∞–º –∏–ª–∏ —Ç–∞–π–º–∫–æ–¥–∞—Ö, –ø—Ä–∏–≤–æ–¥—è—â–∏–µ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –≤–∏–¥–µ–æ.

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏
- ‚úÖ –°–µ—Ä–≤–∏—Å `videoService` —É—Å–ø–µ—à–Ω–æ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ –Ω–∞ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é `ffmpeg`.
- ‚úÖ –ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º.
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É—Ç–µ–π –∏ —Ç–∞–π–º–∫–æ–¥–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- ‚úÖ `ffmpeg` –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Å–µ—Ä–≤–∏—Å–∞.
- ‚úÖ –û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `ffmpeg` –∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.
- ‚úÖ –í–æ—Ä–∫–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç `videoService`.
- ‚úÖ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç unit/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã.
