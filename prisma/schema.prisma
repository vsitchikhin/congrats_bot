// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum for the status of video asset generation
enum AssetStatus {
  PENDING    // Waiting for generation
  GENERATING // Currently being generated
  AVAILABLE  // Generated and ready to use
  FAILED     // Generation failed
}

// Enum for the status of a user request
enum RequestStatus {
  PENDING   // Waiting for video delivery
  COMPLETED // Video delivered successfully
  FAILED    // Delivery failed
}

// Model for a Telegram User
model User {
  id          BigInt   @id
  isBot       Boolean  @default(false)
  firstName   String
  lastName    String?
  username    String?
  phoneNumber String?

  requests UserRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Model for a unique video asset (one per child name)
model VideoAsset {
  id             String      @id @default(cuid())
  name           String      @unique // Normalized child name (lowercase)
  status         AssetStatus @default(PENDING)
  telegramFileId String?     // Cached Telegram file_id for instant delivery

  // Relation to user requests
  userRequests UserRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, status])
}

// Model for a user's request to receive a video
model UserRequest {
  id       String        @id @default(cuid())
  status   RequestStatus @default(PENDING)
  childAge Int?          // Age of the child for this specific request (1-18 years)

  user   User   @relation(fields: [userId], references: [id])
  userId BigInt

  // Relation to the video asset
  asset   VideoAsset @relation(fields: [assetId], references: [id])
  assetId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([assetId, status])
}

// Model for system-wide assets (coupons, etc.)
model SystemAsset {
  id             String  @id @default(cuid())
  key            String  @unique // e.g., 'coupon1', 'coupon2'
  telegramFileId String? // Cached Telegram file_id

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// Model for storing grammY sessions (for @grammyjs/storage-prisma)
model Session {
  key   String @id
  value String

  @@index([key])
}